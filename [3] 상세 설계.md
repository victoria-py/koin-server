# 3) 상세 인터페이스 설계

## 상세 설계

### 1. mcard 생성 시, 카드의 메타데이터에 `must_be_deleted_files` 을 배열로 받음
    ```
    must_be_deleted_files = [
        {'path': '', 'service': 'con-funding'},
        {'path': '', 'service': ''}
    ]
    ```
- 지금은 tenth를 하나만 사용하고 있어서 path 기반으로 delete를 시키고 있는데, path만 받으면 되지 않을까 했는데,,
    - fantem은 con-funding tenth를 사용중,, -> path만 받으면 안됨 (타 서비스의 카드 이미지도 지울 수 있도록..하려면)
    - delete 당시 header(sign)을 생성
    - 현재와 같이 path 만 받는 경우, 
        - 업로드 호스트, 서비스 id, w_secret 알아야함
        - (다운로드 도메인인 경우 403 에러 발생)


### 2. Mcard 삭제

[queues.py](https://github.daumkakao.com/blockchain-tf/koin-server/blob/master/mcard/services/queues.py) 내에 아래 함수 생성 

```python
def enqueue_must_be_deleted_files(must_be_deleted_files, request_id=None)
    publisher = QueuePublisher(name='file.remove',type='direct')

    for file in must_be_deleted_files:
        publisher.publish({'file_remove':file}, request_id=request_id)
    return
```

[workers/mcard](https://github.daumkakao.com/blockchain-tf/koin-server/tree/master/workers/mcard)
하위에 **file_remover.py** 생성

```python
# file_remover.py
class FileRemover(QueueConsumer):
    NAME = 'workers.file.remover'
    DEFAULT_EXCHANGE_NAME = 'file.remove'
```

### ERC721인 경우

[transaction_post_process_map.py#L242](https://github.daumkakao.com/blockchain-tf/koin-server/blob/master/workers/transaction/transaction_post_process_map.py#L242)

```python
def post_process_erc721_burn(transaction: Transaction, callback_publisher=None):
  if transaction.state == Transaction.State.CONFIRMED:
    try:
        mcard = mcards_service.get_mcard(q={'serial':transaction.tokens_transferred.value})
        mcard.delete()
        -----> 이 시점에 enqueue_must_be_deleted_files(mcard.meta.must_be_deleted_files) 
    exceptExceptionase:
        logger.error(str(e),exc_info=1)
```

### DB형인 경우

[mcards_service.py#L806](https://github.daumkakao.com/blockchain-tf/koin-server/blob/master/mcard/services/mcards_service.py#L806)

```python
if mcard.type == MCard.Type.ERC721:
    tx_hash = _burn_mcard(mcard, mcard_package,from_user, related_transaction,nonce)

    if wait_for_transaction:
        w3 = Web3Wrapper(http_provider=settings.BLOCK_CHAIN_NODE['default']['URI'])
        try:
            w3.wait_for_transaction_receipt(tx_hash)
        exceptTimeout:
            raiseBlockchainTimeout()
else:
    mcard.delete()
    ----> 이 시점에 enqueue_must_be_deleted_files(mcard.meta.must_be_deleted_files) 
    _update_to_confirmed_transaction(related_transaction)
```
